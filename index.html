<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>WebAR MVP - Гарантированная работа</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- Стабильная версия AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r17/Stats.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .instructions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px;
            z-index: 2;
            border-top: 2px solid #4285F4;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .markers {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .marker-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .markers img {
            width: 120px;
            height: 120px;
            border: 2px solid #4285F4;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            margin-bottom: 8px;
        }
        
        .marker-label {
            font-weight: bold;
            color: #4285F4;
            margin-bottom: 5px;
        }
        
        #stats {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }
        
        .status {
            margin-top: 10px;
            padding: 8px;
            background: #e8f0fe;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #debug {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            z-index: 100;
            font-family: monospace;
        }
        
        .warning {
            color: #d9534f;
            font-weight: bold;
            margin-top: 5px;
        }
        
        button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
    >
        <!-- Маркер HIRO: Цилиндр -->
        <a-marker 
            preset="hiro"
            emitevents="true" 
            id="marker-hiro">
            <a-cylinder 
                color="#FF5733" 
                radius="0.5" 
                height="1" 
                position="0 0.5 0"
                rotation="0 180 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
            </a-cylinder>
        </a-marker>
        
        <!-- Маркер KANJI: Куб -->
        <a-marker 
            preset="kanji"
            emitevents="true" 
            id="marker-kanji">
            <a-box 
                color="#4CC3D9" 
                position="0 0.5 0" 
                scale="0.5 0.5 0.5"
                animation="property: position; to: 0 1 0; dir: alternate; loop: true; dur: 2000">
            </a-box>
        </a-marker>
        
        <!-- Явное указание камеры -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <div class="instructions">
        <h2>WebAR Технологический MVP</h2>
        <p>Наведите камеру на один из маркеров:</p>
        
        <div class="markers">
            <div class="marker-item">
                <img src="https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/trex-image/trex-image-big.jpeg" 
                     alt="HIRO маркер">
                <span class="marker-label">HIRO маркер</span>
                <p>3D-цилиндр с анимацией</p>
            </div>
            
            <div class="marker-item">
                <img src="https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/kanji/kanji.png" 
                     alt="KANJI маркер">
                <span class="marker-label">KANJI маркер</span>
                <p>Анимированный куб</p>
            </div>
        </div>
        
        <div class="status">
            <div>Статус: <span id="statusText">Инициализация...</span></div>
            <div>Поддержка: <span id="supportText">Проверка...</span></div>
            <div id="errorText" class="warning"></div>
        </div>
        
        <button id="restartBtn">Перезапустить AR</button>
        <p><small>Используйте маркеры с экрана другого устройства или распечатайте</small></p>
    </div>
    
    <div id="stats"></div>
    <div id="debug">Отладка: инициализация...</div>

    <script>
        // Проверка поддержки WebAR
        const isWebARSupported = () => {
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isChrome = /Chrome/.test(navigator.userAgent);
            
            return hasGetUserMedia && (!isIOS || isChrome);
        };
        
        // Элементы интерфейса
        const statusText = document.getElementById('statusText');
        const supportText = document.getElementById('supportText');
        const errorText = document.getElementById('errorText');
        const debugEl = document.getElementById('debug');
        const restartBtn = document.getElementById('restartBtn');
        
        // Обновление статуса
        const updateStatus = (text) => {
            statusText.textContent = text;
        };
        
        const updateSupport = (text) => {
            supportText.textContent = text;
        };
        
        const showError = (text) => {
            errorText.textContent = text;
        };
        
        const updateDebug = (text) => {
            debugEl.textContent = text;
        };
        
        // Инициализация AR
        const initAR = () => {
            // Сброс предыдущих ошибок
            showError('');
            
            try {
                // Проверка поддержки
                if (!isWebARSupported()) {
                    updateSupport("Не поддерживается ❌");
                    showError("Ваш браузер/устройство не поддерживает необходимые функции WebAR");
                    return;
                }
                
                updateSupport("Поддерживается ✅");
                updateStatus("Запрос доступа к камере...");
                
                // Проверка наличия сцены
                const scene = document.querySelector('a-scene');
                if (!scene) {
                    showError("Сцена AR не найдена!");
                    return;
                }
                
                // Обработка событий сцены
                scene.addEventListener('arjs-video-loaded', () => {
                    updateStatus("Камера активирована");
                });
                
                scene.addEventListener('renderstart', () => {
                    updateStatus("AR инициализирован! Наведите на маркер");
                });
                
                scene.addEventListener('error', (e) => {
                    showError(`Ошибка сцены: ${e.detail}`);
                });
                
                // Инициализация статистики
                const stats = new Stats();
                stats.showPanel(0);
                document.getElementById('stats').appendChild(stats.dom);
                
                // Обновление статистики
                scene.addEventListener('renderstart', () => {
                    requestAnimationFrame(function updateStats() {
                        stats.update();
                        requestAnimationFrame(updateStats);
                    });
                });
                
                // Обработчики маркеров
                document.getElementById('marker-hiro').addEventListener('markerFound', () => {
                    updateStatus("Маркер HIRO обнаружен!");
                    updateDebug("HIRO: активен");
                });
                
                document.getElementById('marker-hiro').addEventListener('markerLost', () => {
                    updateDebug("HIRO: не найден");
                });
                
                document.getElementById('marker-kanji').addEventListener('markerFound', () => {
                    updateStatus("Маркер KANJI обнаружен!");
                    updateDebug("KANJI: активен");
                });
                
                // Отладочная информация
                setInterval(() => {
                    const hiroMarker = document.getElementById('marker-hiro');
                    const kanjiMarker = document.getElementById('marker-kanji');
                    
                    let debugInfo = `HIRO: ${hiroMarker.object3D.visible ? 'виден' : 'не виден'}`;
                    debugInfo += ` | KANJI: ${kanjiMarker.object3D.visible ? 'виден' : 'не виден'}`;
                    
                    if (scene.systems && scene.systems.arjs) {
                        debugInfo += ` | FPS: ${Math.round(stats.fps || 0)}`;
                    }
                    
                    updateDebug(debugInfo);
                }, 500);
                
            } catch (e) {
                showError(`Ошибка инициализации: ${e.message}`);
                console.error(e);
            }
        };
        
        // Перезапуск AR
        restartBtn.addEventListener('click', () => {
            updateStatus("Перезапуск AR...");
            setTimeout(initAR, 500);
        });
        
        // Запуск при загрузке
        window.addEventListener('DOMContentLoaded', initAR);
    </script>
</body>
</html>
